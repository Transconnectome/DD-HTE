---
title: "DD GRF ATE"
author: "PJH"
date: '2022-11-21'
output: html_document
---


```{r Preparation}
rm(list=ls())


data$sex_0y<-as.factor(data$sex_0y)
data$married_0y<-as.factor(data$married_0y)
data$parent_identity_0y<-as.factor(data$parent_identity_0y)
data$race_ethnicity_0y<-as.factor(data$race_ethnicity_0y)


library(fastDummies)

data<-dummy_cols(data, select_columns = c('sex_0y', 'married_0y', 'race_g', 'parent_identity_0y', 'race_ethnicity_0y'))

library(learnr)
library(DiagrammeR)
library(grf)
library(tidyverse)
library(broom)
library(fastDummies)
library(lmtest)
library(rpart)
library(glmnet)
library(splines)
library(MASS)
library(sandwich)
library(ggplot2)
library(data.table)

covariates<-c('age_0y', 'bmi_0y', 'income_0y', 
                 'high_educ_0y', 'sex_0y_F', 
                 'married_0y_2', 'married_0y_3', 'married_0y_4', 'married_0y_5', 'married_0y_6',
                 'parent_identity_0y_2','parent_identity_0y_3', 
                 'parent_identity_0y_4', 'parent_identity_0y_5',
                 'race_ethnicity_0y_2', 'race_ethnicity_0y_3', 
                 'race_ethnicity_0y_4', 'race_ethnicity_0y_5',
                 'parent_age_0y', 
                 'nihtbx_totalcomp_uncorrected_0y', 'history_ratio_0y')

W = data$rh_adi_bi_0y
X = data[, covariates]
Z = data$section8_0y
n = nrow(data)

```

```{r ATE: Delay Discounting 1year}
####################### ATE: Discounting 1 year ###################################

Y <- data[, 'discount_rate_1y']
set.seed(123, kind = "Mersenne-Twister", normal.kind = "Inversion", sample.kind = "Rejection")
cforest <- instrumental_forest(X, Y, W, Z,
                               num.trees = 40000,
                                 tune.parameters = c('sample.fraction', 'mtry', 'min.node.size', 'alpha', 'imbalance.penalty'),
                                 tune.num.trees = 5000,
                                 tune.num.reps = 200,
                                 tune.num.draws = 4000)
  
  
  
  ############### AIPW Average Treatment Effect ##################
  aipw.scores<-get_scores(cforest, num.trees.for.weights = 5000)
  ate.aipw.est <- mean(aipw.scores)
  ate.aipw.se <- sd(aipw.scores) / sqrt(n)
  ate.aipw.tstat <- ate.aipw.est / ate.aipw.se
  ate.aipw.pvalue <- 2*(1-pnorm(abs(ate.aipw.tstat)))
  lowci<- ate.aipw.est + -1 * qnorm(0.975) * ate.aipw.se 
  highci<- ate.aipw.est + 1 * qnorm(0.975) * ate.aipw.se 
  ate.aipw.results <- as.data.frame(cbind(ate.aipw.est, ate.aipw.se, ate.aipw.tstat, ate.aipw.pvalue, lowci, highci))
  rownames(ate.aipw.results)<-'discount_rate_1y'
  colnames(ate.aipw.results)<-c("Estimate", "Std.Error", "t", "P-value", "95% LowCI", "95% High CI")
  print(ate.aipw.results)
  
    ################### Variable Importance of Heterogeneity #######################
  
  var_imp <- round(c(variable_importance(cforest)), 10)
  names(var_imp) <- covariates
  sorted_var_imp <- sort(var_imp, decreasing = TRUE)
  sorted_var_imp<-as.data.frame(sorted_var_imp)
  setDT(sorted_var_imp, keep.rownames=TRUE)[]
  print(sorted_var_imp)

  
ate.aipw.results$Outcome<-row.names(ate.aipw.results)
ate.aipw.results<-ate.aipw.results[, c("Outcome", "Estimate", "Std.Error", "t", "P-value", "95% LowCI", "95% High CI")]
colnames(sorted_var_imp)<-c("Variables", paste0("Importance_", row.names(ate.aipw.results)))
list_res<-list(ATE=ate.aipw.results, VarImp=sorted_var_imp)
openxlsx::write.xlsx(list_res, rowNames=FALSE, paste0("GRF Results_New_ATE\\", row.names(ate.aipw.results), ".xlsx"))


```


```{r ATE: Distress 1year}
####################### ATE: Distress Score PLEs 1 year ###################################

y<-'distress_score_pps_1y'
  
Y <- data[, y]
set.seed(123, kind = "Mersenne-Twister", normal.kind = "Inversion", sample.kind = "Rejection")
cforest <- instrumental_forest(X, Y, W, Z,
                               num.trees = 40000,
                                 tune.parameters = c('sample.fraction', 'mtry', 'min.node.size', 'alpha', 'imbalance.penalty'),
                                 tune.num.trees = 3000,
                                 tune.num.reps = 200,
                                 tune.num.draws = 2000)
  
  
  
  ############### AIPW Average Treatment Effect ##################
  aipw.scores<-get_scores(cforest, num.trees.for.weights = 5000)
  ate.aipw.est <- mean(aipw.scores)
  ate.aipw.se <- sd(aipw.scores) / sqrt(n)
  ate.aipw.tstat <- ate.aipw.est / ate.aipw.se
  ate.aipw.pvalue <- 2*(1-pnorm(abs(ate.aipw.tstat)))
  lowci<- ate.aipw.est + -1 * qnorm(0.975) * ate.aipw.se 
  highci<- ate.aipw.est + 1 * qnorm(0.975) * ate.aipw.se 
  ate.aipw.results <- as.data.frame(cbind(ate.aipw.est, ate.aipw.se, ate.aipw.tstat, ate.aipw.pvalue, lowci, highci))
  rownames(ate.aipw.results)<-y
  colnames(ate.aipw.results)<-c("Estimate", "Std.Error", "t", "P-value", "95% LowCI", "95% High CI")
  print(ate.aipw.results)
  
    ################### Variable Importance of Heterogeneity #######################
  
  var_imp <- round(c(variable_importance(cforest)), 10)
  names(var_imp) <- covariates
  sorted_var_imp <- sort(var_imp, decreasing = TRUE)
  sorted_var_imp<-as.data.frame(sorted_var_imp)
  setDT(sorted_var_imp, keep.rownames=TRUE)[]
  print(sorted_var_imp)


ate.aipw.results$Outcome<-y
ate.aipw.results<-ate.aipw.results[, c("Outcome", "Estimate", "Std.Error", "t", "P-value", "95% LowCI", "95% High CI")]
colnames(sorted_var_imp)<-c("Variables", paste0("Importance_", y))
list_res<-list(ATE=ate.aipw.results, VarImp=sorted_var_imp)
openxlsx::write.xlsx(list_res, rowNames=FALSE, paste0("GRF Results_New_ATE\\", y, "_baseline.xlsx"))

```



```{r ATE: Distress 2year}
####################### ATE: Distress Score PLEs 2 year ###################################

y<-'distress_score_pps_2y'
  
Y <- data[, y]
set.seed(123, kind = "Mersenne-Twister", normal.kind = "Inversion", sample.kind = "Rejection")
cforest <- instrumental_forest(X, Y, W, Z,
                               num.trees = 40000,
                                 tune.parameters = c('sample.fraction', 'mtry', 'min.node.size', 'alpha', 'imbalance.penalty'),
                                 tune.num.trees = 3000,
                                 tune.num.reps = 200,
                                 tune.num.draws = 2000)
  
  
  
  ############### AIPW Average Treatment Effect ##################
  aipw.scores<-get_scores(cforest, num.trees.for.weights = 5000)
  ate.aipw.est <- mean(aipw.scores)
  ate.aipw.se <- sd(aipw.scores) / sqrt(n)
  ate.aipw.tstat <- ate.aipw.est / ate.aipw.se
  ate.aipw.pvalue <- 2*(1-pnorm(abs(ate.aipw.tstat)))
  lowci<- ate.aipw.est + -1 * qnorm(0.975) * ate.aipw.se 
  highci<- ate.aipw.est + 1 * qnorm(0.975) * ate.aipw.se 
  ate.aipw.results <- as.data.frame(cbind(ate.aipw.est, ate.aipw.se, ate.aipw.tstat, ate.aipw.pvalue, lowci, highci))
  rownames(ate.aipw.results)<-y
  colnames(ate.aipw.results)<-c("Estimate", "Std.Error", "t", "P-value", "95% LowCI", "95% High CI")
  print(ate.aipw.results)
  
    ################### Variable Importance of Heterogeneity #######################
  
  var_imp <- round(c(variable_importance(cforest)), 10)
  names(var_imp) <- covariates
  sorted_var_imp <- sort(var_imp, decreasing = TRUE)
  sorted_var_imp<-as.data.frame(sorted_var_imp)
  setDT(sorted_var_imp, keep.rownames=TRUE)[]
  print(sorted_var_imp)


ate.aipw.results$Outcome<-y
ate.aipw.results<-ate.aipw.results[, c("Outcome", "Estimate", "Std.Error", "t", "P-value", "95% LowCI", "95% High CI")]
colnames(sorted_var_imp)<-c("Variables", paste0("Importance_", y))
list_res<-list(ATE=ate.aipw.results, VarImp=sorted_var_imp)
openxlsx::write.xlsx(list_res, rowNames=FALSE, paste0("GRF Results_New_ATE\\", y, "_baseline.xlsx"))

```


```{r ATE: Delusional 1year}
r####################### ATE: Delusional Score PLEs 1 year ###################################

y<-'distress_score_di_1y'
  
Y <- data[, y]
set.seed(123, kind = "Mersenne-Twister", normal.kind = "Inversion", sample.kind = "Rejection")
cforest <- instrumental_forest(X, Y, W, Z,
                               num.trees = 40000,
                                 tune.parameters = c('sample.fraction', 'mtry', 'min.node.size', 'alpha', 'imbalance.penalty'),
                                 tune.num.trees = 3000,
                                 tune.num.reps = 200,
                                 tune.num.draws = 2000)
  
  
  
  ############### AIPW Average Treatment Effect ##################
  aipw.scores<-get_scores(cforest)
  ate.aipw.est <- mean(aipw.scores)
  ate.aipw.se <- sd(aipw.scores) / sqrt(n)
  ate.aipw.tstat <- ate.aipw.est / ate.aipw.se
  ate.aipw.pvalue <- 2*(1-pnorm(abs(ate.aipw.tstat)))
  lowci<- ate.aipw.est + -1 * qnorm(0.975) * ate.aipw.se 
  highci<- ate.aipw.est + 1 * qnorm(0.975) * ate.aipw.se 
  ate.aipw.results <- as.data.frame(cbind(ate.aipw.est, ate.aipw.se, ate.aipw.tstat, ate.aipw.pvalue, lowci, highci))
  rownames(ate.aipw.results)<-y
  colnames(ate.aipw.results)<-c("Estimate", "Std.Error", "t", "P-value", "95% LowCI", "95% High CI")
  print(ate.aipw.results)
  
    ################### Variable Importance of Heterogeneity #######################
  
  var_imp <- round(c(variable_importance(cforest)), 10)
  names(var_imp) <- covariates
  sorted_var_imp <- sort(var_imp, decreasing = TRUE)
  sorted_var_imp<-as.data.frame(sorted_var_imp)
  setDT(sorted_var_imp, keep.rownames=TRUE)[]
  print(sorted_var_imp)


ate.aipw.results$Outcome<-y
ate.aipw.results<-ate.aipw.results[, c("Outcome", "Estimate", "Std.Error", "t", "P-value", "95% LowCI", "95% High CI")]
colnames(sorted_var_imp)<-c("Variables", paste0("Importance_", y))
list_res<-list(ATE=ate.aipw.results, VarImp=sorted_var_imp)
openxlsx::write.xlsx(list_res, rowNames=FALSE, paste0("GRF Results_New_ATE\\", y, "_baseline.xlsx"))

```


```{r ATE: Delusional 2year}
r####################### ATE: Delusional Score PLEs 2 year ###################################

y<-'distress_score_di_2y'
  
Y <- data[, y]
set.seed(123, kind = "Mersenne-Twister", normal.kind = "Inversion", sample.kind = "Rejection")
cforest <- instrumental_forest(X, Y, W, Z,
                               num.trees = 40000,
                                 tune.parameters = c('sample.fraction', 'mtry', 'min.node.size', 'alpha', 'imbalance.penalty'),
                                 tune.num.trees = 3000,
                                 tune.num.reps = 200,
                                 tune.num.draws = 2000)
  
  
  
  ############### AIPW Average Treatment Effect ##################
  aipw.scores<-get_scores(cforest)
  ate.aipw.est <- mean(aipw.scores)
  ate.aipw.se <- sd(aipw.scores) / sqrt(n)
  ate.aipw.tstat <- ate.aipw.est / ate.aipw.se
  ate.aipw.pvalue <- 2*(1-pnorm(abs(ate.aipw.tstat)))
  lowci<- ate.aipw.est + -1 * qnorm(0.975) * ate.aipw.se 
  highci<- ate.aipw.est + 1 * qnorm(0.975) * ate.aipw.se 
  ate.aipw.results <- as.data.frame(cbind(ate.aipw.est, ate.aipw.se, ate.aipw.tstat, ate.aipw.pvalue, lowci, highci))
  rownames(ate.aipw.results)<-y
  colnames(ate.aipw.results)<-c("Estimate", "Std.Error", "t", "P-value", "95% LowCI", "95% High CI")
  print(ate.aipw.results)
  
    ################### Variable Importance of Heterogeneity #######################
  
  var_imp <- round(c(variable_importance(cforest)), 10)
  names(var_imp) <- covariates
  sorted_var_imp <- sort(var_imp, decreasing = TRUE)
  sorted_var_imp<-as.data.frame(sorted_var_imp)
  setDT(sorted_var_imp, keep.rownames=TRUE)[]
  print(sorted_var_imp)


ate.aipw.results$Outcome<-y
ate.aipw.results<-ate.aipw.results[, c("Outcome", "Estimate", "Std.Error", "t", "P-value", "95% LowCI", "95% High CI")]
colnames(sorted_var_imp)<-c("Variables", paste0("Importance_", y))
list_res<-list(ATE=ate.aipw.results, VarImp=sorted_var_imp)
openxlsx::write.xlsx(list_res, rowNames=FALSE, paste0("GRF Results_New_ATE\\", y, "_baseline.xlsx"))

```


```{r ATE: Hallucination 1year}
####################### ATE: Hallucinational Score PLEs 1 year ###################################

y<-'distress_score_pd_1y'
  
Y <- data[, y]
set.seed(123, kind = "Mersenne-Twister", normal.kind = "Inversion", sample.kind = "Rejection")
cforest <- instrumental_forest(X, Y, W, Z,
                               num.trees = 40000,
                                 tune.parameters = c('sample.fraction', 'mtry', 'min.node.size', 'alpha', 'imbalance.penalty'),
                                 tune.num.trees = 3000,
                                 tune.num.reps = 200,
                                 tune.num.draws = 2000)
  
  
  
  ############### AIPW Average Treatment Effect ##################
  aipw.scores<-get_scores(cforest, num.trees.for.weights = 5000)
  ate.aipw.est <- mean(aipw.scores)
  ate.aipw.se <- sd(aipw.scores) / sqrt(n)
  ate.aipw.tstat <- ate.aipw.est / ate.aipw.se
  ate.aipw.pvalue <- 2*(1-pnorm(abs(ate.aipw.tstat)))
  lowci<- ate.aipw.est + -1 * qnorm(0.975) * ate.aipw.se 
  highci<- ate.aipw.est + 1 * qnorm(0.975) * ate.aipw.se 
  ate.aipw.results <- as.data.frame(cbind(ate.aipw.est, ate.aipw.se, ate.aipw.tstat, ate.aipw.pvalue, lowci, highci))
  rownames(ate.aipw.results)<-y
  colnames(ate.aipw.results)<-c("Estimate", "Std.Error", "t", "P-value", "95% LowCI", "95% High CI")
  print(ate.aipw.results)
  
    ################### Variable Importance of Heterogeneity #######################
  
  var_imp <- round(c(variable_importance(cforest)), 10)
  names(var_imp) <- covariates
  sorted_var_imp <- sort(var_imp, decreasing = TRUE)
  sorted_var_imp<-as.data.frame(sorted_var_imp)
  setDT(sorted_var_imp, keep.rownames=TRUE)[]
  print(sorted_var_imp)


ate.aipw.results$Outcome<-y
ate.aipw.results<-ate.aipw.results[, c("Outcome", "Estimate", "Std.Error", "t", "P-value", "95% LowCI", "95% High CI")]
colnames(sorted_var_imp)<-c("Variables", paste0("Importance_", y))
list_res<-list(ATE=ate.aipw.results, VarImp=sorted_var_imp)
openxlsx::write.xlsx(list_res, rowNames=FALSE, paste0("GRF Results_New_ATE\\", y, "_baseline.xlsx"))

```

```{r ATE: Hallucination 2year}
####################### ATE: Hallucinational Score PLEs 2 year ###################################

y<-'distress_score_pd_2y'
  
Y <- data[, y]
set.seed(123, kind = "Mersenne-Twister", normal.kind = "Inversion", sample.kind = "Rejection")
cforest <- instrumental_forest(X, Y, W, Z,
                               num.trees = 40000,
                                 tune.parameters = c('sample.fraction', 'mtry', 'min.node.size', 'alpha', 'imbalance.penalty'),
                                 tune.num.trees = 3000,
                                 tune.num.reps = 200,
                                 tune.num.draws = 2000)
  
  
  
  ############### AIPW Average Treatment Effect ##################
  aipw.scores<-get_scores(cforest, num.trees.for.weights = 5000)
  ate.aipw.est <- mean(aipw.scores)
  ate.aipw.se <- sd(aipw.scores) / sqrt(n)
  ate.aipw.tstat <- ate.aipw.est / ate.aipw.se
  ate.aipw.pvalue <- 2*(1-pnorm(abs(ate.aipw.tstat)))
  lowci<- ate.aipw.est + -1 * qnorm(0.975) * ate.aipw.se 
  highci<- ate.aipw.est + 1 * qnorm(0.975) * ate.aipw.se 
  ate.aipw.results <- as.data.frame(cbind(ate.aipw.est, ate.aipw.se, ate.aipw.tstat, ate.aipw.pvalue, lowci, highci))
  rownames(ate.aipw.results)<-y
  colnames(ate.aipw.results)<-c("Estimate", "Std.Error", "t", "P-value", "95% LowCI", "95% High CI")
  print(ate.aipw.results)
  
    ################### Variable Importance of Heterogeneity #######################
  
  var_imp <- round(c(variable_importance(cforest)), 10)
  names(var_imp) <- covariates
  sorted_var_imp <- sort(var_imp, decreasing = TRUE)
  sorted_var_imp<-as.data.frame(sorted_var_imp)
  setDT(sorted_var_imp, keep.rownames=TRUE)[]
  print(sorted_var_imp)


ate.aipw.results$Outcome<-y
ate.aipw.results<-ate.aipw.results[, c("Outcome", "Estimate", "Std.Error", "t", "P-value", "95% LowCI", "95% High CI")]
colnames(sorted_var_imp)<-c("Variables", paste0("Importance_", y))
list_res<-list(ATE=ate.aipw.results, VarImp=sorted_var_imp)
openxlsx::write.xlsx(list_res, rowNames=FALSE, paste0("GRF Results_New_ATE\\", y, "_baseline.xlsx"))

```

